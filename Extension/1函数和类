

B——1）定义函数

修改deng.c， php_deng.h不需要动

/*定义函数*/
PHP_FUNCTION(sum)
{
    int x, y, z;
    
    int argc = ZEND_NUM_ARGS();
    
    if (zend_parse_parameters(argc TSRMLS_CC, "ll", &x, &y) == FAILURE)
        return;
    z = x + y;
    RETURN_LONG(z);
}
/*函数声明*/
const zend_function_entry deng_functions[] = {
	PHP_FE(confirm_deng_compiled,	NULL)		/* For testing, remove later. */
    PHP_FE(sum, NULL)
	PHP_FE_END	/* Must be the last line in deng_functions[] */
};
B——2）定义类（属性和方法）

/*
 * define a class
 * 1 - put class and funcs here
 * 2 - modify PHP_MINIT_FUNCTION(deng)
 */
zend_class_entry *myclass_ce;


/* class methods define */
ZEND_METHOD(myclass, public_method)
{
    php_printf("我是public_method方法\n");
}
ZEND_METHOD(myclass, __construct)
{
    php_printf("我是构造方法\n");
}

/* class methods declare */
PHP_METHOD(myclass, public_method);
PHP_METHOD(myclass, __construct);


static zend_function_entry myclass_methods[] =
{
    ZEND_ME(myclass, public_method, NULL, ZEND_ACC_PUBLIC)
    ZEND_ME(myclass, __construct, NULL, ZEND_ACC_PUBLIC | ZEND_ACC_CTOR)
    {NULL, NULL, NULL}
};
 

PHP_MINIT_FUNCTION(deng)
{
	/* If you have INI entries, uncomment these lines
	REGISTER_INI_ENTRIES();
	*/
    
    /* added by shark
     * to register a class
     */
    zend_class_entry ce;
    INIT_CLASS_ENTRY(ce, "myclass", myclass_methods);
    myclass_ce = zend_register_internal_class(&ce TSRMLS_CC);
    
    /* define class property
     * 3 infos are needed: name, value, visit_level
     * ----visit_level----
     * #define ZEND_ACC_STATIC      0x01    static
     * #define ZEND_ACC_PUBLIC      0x100   public
     * #define ZEND_ACC_PROTECTED   0x200   protected
     * #define ZEND_ACC_PRIVATE     8x400   private
     * #define ZEND_ACC_CTOR                __construct
     * #define ZEND_ACC_DTOR                __destruct
     * ----value----
     * zend_declare_property_null   null
     * zend_declare_property_string string
     */
    zend_declare_property_null(myclass_ce, "public_var", strlen("public_var"), ZEND_ACC_PUBLIC TSRMLS_CC);
    
    /* define class constant */
    zend_declare_class_constant_string(myclass_ce, "CONSTANT_VAR", strlen("CPNSTANT_VAR"), "boygirl88.com" TSRMLS_CC);
    
    
    
	return SUCCESS;
}
B——3）测试

<?php
echo confirm_deng_compiled("okok");
echo "\n";


echo  sum(1, 2);
echo "\n";

$gameObject = new myclass();

echo "\n";

var_dump($gameObject);

?>
